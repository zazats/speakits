<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv=”Permissions-Policy” content=”interest-cohort=()”>
    <title>MindSpace</title>
    <link rel="stylesheet" href="viewer.css">	
</head>

<body>
    <div id="btn" class="center">
        <img src="assets/talking_head1.gif" class="image">
        <div class ="text">
		        <h2>Start your MindSpace eXperience</h2>
		        <p>Turn your phone to the horizontal position, <br> 
               click the Start button and inset it in the VR Set. <br> <br>
               v1.23
            </p>
	      </div>
        <button class="button" onclick="startWhisper()">Start</button>
       
        
    </div>
    
    <div id="container"></div>
    
    <div style="width:100%;margin-top:5%; text-align:center; display:none" id="cheat_not_container">
      <p id="cheat_note" style="word-break: break-all; white-space: normal; display:inline-block; width:20%; margin:5% auto; border-radius:255px 15px 225px 15px/15px 225px 15px 255px; padding:1em; line-height:1.5em; background:hsla(67, 95%, 95%, 1); border:solid 2px hsla(0, 95%, 35%, 1)">
	    1. Switch to Level 1 <br>
      2. Switch to Level 2 <br>
      3. Switch to Level 3 <br>
      4. Questions <br>
      5. Relax mode <br>
      6. Exit <br>
      </p>
    </div>	

    <script src="speakits_viewer_files/three.min.js"></script>
    <script src="speakits_viewer_files/panolens.min.js"></script>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>    
    <script type="module" src="/javascript/globalVars.js"></script>
    <script type="module" src="javascript/audioFeedback.js"></script>
    <script type="module" src="keys.js"></script>

	    <script>
      let recognition = null;
      const MENU_ICON_SIZE = 120;

      // Check browser support for the Web Speech API
      if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
        // Initialize SpeechRecognition object
        let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        let questionBuffer = null;
        
        // Configure recognition settings
        recognition.continuous = true; // Continue listening for speech
        recognition.interimResults = false; // Get interim results before final transcription
        recognition.lang = 'en-US'; // Language setting (adjust as needed)
  
        // Start listening when button is clicked
        //document.getElementById('startButton').addEventListener('click', function() {
        recognition.start();
        
        // Variable to track if "Hi Whisper" has been spoken
        let hiWhisperSpoken = false;
        let welcomeSpoken = false;
      

        // Event handler for receiving transcribed text
        recognition.onresult = function(event) {                 
          speechBuffer = event.results;
          console.log(speechBuffer[speechBuffer.length - 1][0].transcript);
          if (hiWhisperSpoken) {
            let result = event.results[event.results.length - 1];
            let transcript = result[0].transcript;
            if (transcript.toLowerCase().includes('thank you')) { 
              const startPhrase = "hey whisper";
              const stopPhrase = "thank you";
              
              let concatenatedString = concatenateAfterSpecificPhrase(event.results, startPhrase, stopPhrase);
              console.log(concatenatedString); 
              hiWhisperSpoken=false;
              const whisperFinalResponsePath = "assets/ok_give_me_few_seconds.mp3";
              PlaySound(whisperFinalResponsePath);
              hideWhisper();
              //document.getElementById("count_down").style.display = "compact";
              loadWhisperVenue(concatenatedString);
              if (recognition != null) {
                recognition.stop();
              }

            } else if (transcript.toLowerCase().includes('goodbye')) { 
              hiWhisperSpoken=false;
              PlaySound( "assets/see_you_later.mp3");
              hideWhisper();
              if (recognition != null) {
                recognition.stop();
              }
              window.history.go(-1);
              
            }else if (transcript.toLowerCase().includes('ignore')) { 
              hiWhisperSpoken=false;
              PlaySound( "assets/ok.mp3");
              hideWhisper();
              if (recognition != null) {
                recognition.stop();
              }
              sleep(1000);
              audioTrack.play();
            } else if (transcript.toLowerCase().includes('next level')) { 
              hiWhisperSpoken=false;
              PlaySound( "assets/ok.mp3");
              hideWhisper();
              if (recognition != null) {
                recognition.stop();
              }
              tougleLevel();
            } else if (transcript.toLowerCase().includes('stop')) { 
              hiWhisperSpoken=false;
<<<<<<< HEAD
              playSoundAndAskQuestion("assets/ok.mp3");
              /*PlaySound( "assets/ok.mp3");
              hideWhisper();
              sleep(300);
              askQuestion(imagesSettings[sessionName]);*/
              
=======
              //PlaySound( "assets/ok.mp3");
              //hideWhisper();
              //sleep(1000);
              askQuestion(imagesSettings[sessionName]);
>>>>>>> 8e1beec922e8df69679a25c24d4e2844672c0c63
              if (recognition != null) {
                recognition.stop();
              }
              //window.history.go(-1);
              
            }
          }else {
            const transcript = event.results[event.results.length - 1][0].transcript;
            if (transcript.toLowerCase().includes('hey whisper')) {
                callForWhisper();
            } else if (transcript.toLowerCase().includes('any questions') || transcript.toLowerCase().includes('more questions')) {
              //PlaySound( "assets/questions_please.mp3");
              // call ChatGPT API to generate questions from the prompt
              startAskingQuestions(true);
            } else if (transcript.toLowerCase().includes('over to you') ) {
              // call ChatGPT API to generate questions from the prompt
              hideWhisper();
              analyseAnswer(imagesSettings[sessionName]);
            }
          }
        };

        function callForWhisper(){
          hiWhisperSpoken = true;
          showWhisper();
          let whisperInitResponsePath = "assets/hi.mp3";
          if (!welcomeSpoken){
            welcomeSpoken = true;
          }else{
              whisperInitResponsePath = "assets/yes.mp3"
          }
          PlaySound(whisperInitResponsePath);
        }
  
      function startAskingQuestions(isFromWhisper) {
        let par2 = null;
        if(isFromWhisper) par2 = "any questions";
        
        if (questionBuffer == null) {
          questionBuffer = concatenateAfterSpecificPhrase(speechBuffer, null, par2);
        }
        generateQuestions("phrase", questionBuffer).then(function(response){ 
          speak(response);
        })
      }

      function analyseAnswer(imageSettings) {
        questionBuffer = concatenateAfterSpecificPhrase(speechBuffer, null, 'over to you');
          analyzeAnswerNoCallforAPI(imageSettings.protocol,imageSettings.questionText,questionBuffer).then(function(response){ 
          console.log(response);   
       })
      }   
        // Event handler for errors
      
      recognition.onerror = function(event) {
          //console.error('Speech recognition error:', event.error);
        };
      } else {
        // Browser doesn't support Web Speech API
        console.error('Browser does not support Web Speech API');
      }
      // Event handler for when speech recognition ends
      recognition.onend = function() {
        //console.log('Speech recognition ended');
      // Automatically restart speech recognition after it ends
        if(recognition != null) recognition.start();
      };
    
      window.showWhisper = function showWhisper(){
        if(infospot == null){
          infospot = new PANOLENS.Infospot(500, 'assets/talking_head1.gif', true);
          //infospot.addHoverElement(document.getElementById('cheat_note'), 200);
          infospot.position.set(0, -0, -1000); //infospot.dispose();
          panorama.add(infospot);
        }
    
        infospot.show();
      }
  
    window.hideWhisper = function hideWhisper(){
      if(infospot != null){
        infospot.hide();
        infospot.dispose();
        infospot = null;
      }
    }
 

    let lastZ = null;
    const threshold = 1; // Adjust this value to control sensitivity
    const moveDistance = 100; // Adjust this value for faster or slower movement

    function handleMotion(event) {
      const acceleration = event.accelerationIncludingGravity;
      if (acceleration) {
          const z = acceleration.z;

          if (lastZ !== null) {
              const deltaZ = z - lastZ;

              const camera = viewer.getCamera();

              if (deltaZ > threshold) {
                  // Move camera backward
                  camera.translateZ(moveDistance);
              } else if (deltaZ < -threshold) {
                  // Move camera forward
                  camera.translateZ(-moveDistance);
              }
          }

          lastZ = z;
      }
    }

    function handleCamera(event) {
      const key = event.key; // "ArrowUp", "ArrowDown"
      const camera = viewer.getCamera();
      const moveDistance = 100; // Adjust this value for faster or slower movement

      if (key === 'f') {
        camera.translateZ(-moveDistance);
      } else if (key === 'b') {
        camera.translateZ(moveDistance);
      }
    }

    function startWhisper() {
          if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
             DeviceOrientationEvent.requestPermission();
             //window.addEventListener('devicemotion', handleMotion, true);    
          }
          
          window.addEventListener('keydown', handleCamera, true);

          if (!document.fullscreenElement) {

            let element = document.body;
            let requestFSFunction = element.requestFullScreen || element.webkitRequestFullscreen || element.webkitRequestFullScreen || document.requestFullscreen || document.msRequestFullscreen || document.mozRequestFullScreen;
            if (requestFSFunction) {
                requestFSFunction.apply(element);
              
            }
            else {
                // element.requestFullScreen();jhvhgv
                console.log("ERR:", "Fullscreen failed!");
            }
          }
          else {
            document.exitFullscreen();
          // console.log("DEBUG:",this.entity.findByTag("buttonText"));
          }
          
          container = document.querySelector('#container');
          const urlParams = new URL(window.location.toLocaleString()).searchParams;
          sessionName = urlParams.get('session');
          currentUserId = urlParams.get('user');
          let isDebug = urlParams.get('isDebug');
          let demoMode = urlParams.get('demo');


          displayImage(imagesSettings[sessionName],isDebug,demoMode);
          noSleep.enable();
          document.getElementById("btn").style.display = "none";
          

          exitBtn = createExitButton();
          questionsBtn = createQuestionsButton();
          levelBtn = createLevel1Button();
          //relaxBtn = createRelaxButton();

          viewer.setPanorama(panorama);
          //analyseAnswer();
    }

    function tougleLevel(){
      const scene = viewer.getScene();
      // Count the number of panoramas in the scene
      const numPanoramas = scene.children.length;
      if(currentLevel < numPanoramas - 1) {
        currentLevel = currentLevel + 1;
      } else {
        currentLevel = 0;
      }      
      panorama = scene.children[currentLevel];
      viewer.setPanorama(panorama);
      //anorama.add(infospot); // add Whisper
      hideWhisper();
    }

    function PlaySound(audioPath) {
        audioTrack.pause();
        let audio = new Audio(audioPath);
        audio.loop = false;
        audio.play();
    }

    function speak(textToSay) {
          // Check browser support for SpeechSynthesis
          if ('speechSynthesis' in window) {
            // Create a new instance of SpeechSynthesisUtterance
            let utterance = new SpeechSynthesisUtterance(textToSay);
            // Optionally, configure speech parameters
            utterance.lang = 'en-US'; // Language setting (adjust as needed)
            utterance.pitch = 1;
            utterance.rate = 1;
            // Speak the text
            window.speechSynthesis.speak(utterance);
          } else {
            // Browser doesn't support SpeechSynthesis
            alert('Your browser does not support text-to-speech.');
          }
        }

    function concatenateAfterSpecificPhrase(array, startKeyword, endKeyword) {
        let isConcatenating = false;
        let result = '';
        let currentPhrase="";

        for (let i = 0; i < array.length; i++) {
            currentPhrase += array[i][0].transcript;
        }
        let startRegex = "empty";
        if (startKeyword==null){
          startRegex = new RegExp('(.*?)' + endKeyword, 'g');
          if (endKeyword==null){
            return currentPhrase;
          }
        }else{
          startRegex = new RegExp(startKeyword + '(.*?)' + endKeyword, 'g');
        }  
            
      // Find all matches
        let match;
        while ((match = startRegex.exec(currentPhrase.toLowerCase())) !== null) {
            result += match[1]; // Concatenate the text between the keywords
        }

        return result;
        
    }

    async function loadVenueEvent(eventData) {
      console.log(eventData);
      PlaySound('assets/working_on_it.mp3');
      if(eventData.status == 'complete'){
        PlaySound('assets/done.mp3');
        const imageSettings = imagesSettings["imagine1"];
        imageSettings.image = eventData.file_url;
        displayImage(imageSettings)
        panorama.add(levelBtn);
        panorama.add(questionsBtn);
        panorama.add(exitBtn);
        panorama.add(relaxBtn);
      }
    }

    async function displayImage(imageSettings,isDebug,demoMode) {
      //const imageSettings = imagesSettings[sessionName];
      //let audio;
      if (isDebug == null || isDebug == 0) {
        audioTrack = new Audio(imageSettings.audio );
      } else {
        audioTrack = new Audio( 'assets/zendel/Debug.mp3');
      }

      audioTrack.loop = false;
      audioTrack.play();

      if (demoMode != null) {
        setTimeout(() => {
          audioTrack.pause(); // Pause the audio
          audioTrack.currentTime = 0; // Reset the audio to the beginning
            // Simulate the onended event
            //const endedEvent = new Event('ended');
            //audioTrack.dispatchEvent(endedEvent);
            askQuestion(imageSettings);
        }, 10000);
      }
        
      audioTrack.onended =  function() {
        askQuestion();
      };
            
      let newPanorama = new PANOLENS.ImagePanorama(imageSettings.image || 'assets/' + sessionName, 50);
      panorama = newPanorama;
      //panorama.add(infospot);

      const imagePosition = imageSettings.position;
      newPanorama.addEventListener('enter-fade-start', () => {
          viewer.tweenControlCenter(new THREE.Vector3(imagePosition[0],imagePosition[1],imagePosition[2]), 0)
      })

      if (viewer == null) {
        viewer = new PANOLENS.Viewer({ container: container });
        //viewer.add(panorama);
      }
             
      viewer.add(newPanorama);
      viewer.setPanorama(newPanorama);
      
      let ef = 1, ctrl = 0;
      if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(navigator.userAgent)) {
          ef = 2;
          ctrl = 1;
      }
      viewer.enableControl(ctrl);
      viewer.enableEffect(ef);
      viewer.setCameraFov(90);
    }

    async function displayGeneratedImage(imageSettings) {
        //const imageSettings = imagesSettings[sessionName];
      
        let audio = new Audio(imageSettings.audio || 'assets/imagine_l1.mp3');
        audio.loop = true;
        audio.play();
      
        //infospot = new PANOLENS.Infospot(300, 'assets/notes4.png', true);
      
        //infospot.position.set(0, -1000, -1000);
        //infospot.addHoverElement(document.getElementById('cheat_note'), 200);
        panorama = new PANOLENS.ImagePanorama(imageSettings.image || 'assets/' + sessionName, 50);
        //panorama.add(infospot);
      
        const imagePosition = imageSettings.position;
        panorama.addEventListener('enter-fade-start', () => {
            viewer.tweenControlCenter(new THREE.Vector3(imagePosition[0],imagePosition[1],imagePosition[2]), 0)
        })
        if (viewer == null) {
            viewer = new PANOLENS.Viewer({ container: container });
            viewer.add(panorama);
          }
          else {
            viewer.setPanorama(panorama);
          }
      
        let ef = 1, ctrl = 0;
        if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(navigator.userAgent)) {
            ef = 2;
            ctrl = 1;
        }
        viewer.enableControl(ctrl);
        viewer.enableEffect(ef);
        viewer.setCameraFov(90);
    }

    async function loadVenue() {
          noSleep.enable();
          document.getElementById("btn").style.display = "none";

          container = document.querySelector('#container');
          const urlParams = new URL(window.location.toLocaleString()).searchParams;
          let sessionName = urlParams.get('session');
          let imageNote = urlParams.get('cheat_note');
          let imagine_file_url = null;
          
          //build AI generated venues
          if (sessionName == "imagine") {
            let rnd = Math.floor(Math.random() * 5) + 1;
              sessionName = "imagine" + rnd;
              let myHeaders = new Headers();
              myHeaders.append("x-api-key", IMAGINE);

              //trying to generate an image from the SkyBox
            
      
              let requestOptions = {
                  method: "POST",
                  headers: myHeaders,
                  redirect: "follow"
              };

            const response = await fetch(`https://backend.blockadelabs.com/api/v1/skybox?prompt=${imageNote}`, requestOptions);
            //const response = await fetch('https://jsonplaceholder.typicode.com/posts/1',);
            const data = await response.json();
            console.log(data);

            Pusher.logToConsole = true;
            pusher = new Pusher('a6a7b7662238ce4494d5', {
              appId: "1555452",
              key: "a6a7b7662238ce4494d5",
              secret: "5b69dc3f0bb7800ed8d0",
              cluster: "mt1"
            });
            
            // Subscribe to the channel you want to receive events from
            channel = pusher.subscribe(data.pusher_channel);
            channel.bind(data.pusher_event, loadVenueEvent);      
          }else{
            displayImage(imagesSettings[sessionName]);
          }
    }

      //Generates the request to the Blockadel API to generate 360 inage from the prompt
      //the function generte asynchronous request. The response will be received by webhook function loadVenueEvent()
      async function loadWhisperVenue(imagePrompt) {
          
          noSleep.enable();
        
          document.getElementById("btn").style.display = "none";

          container = document.querySelector('#container');

          let myHeaders = new Headers();
          myHeaders.append("x-api-key", IMAGINE);
                    
          let requestOptions = {
              method: "POST",
              headers: myHeaders,
              redirect: "follow"
          };

          const response = await fetch(`https://backend.blockadelabs.com/api/v1/skybox?prompt=${imagePrompt}`, requestOptions);
          const data = await response.json();

          Pusher.logToConsole = true;
          pusher = new Pusher('a6a7b7662238ce4494d5', {
          appId: "1555452",
          key: "a6a7b7662238ce4494d5",
          secret: "5b69dc3f0bb7800ed8d0",
          cluster: "mt1"
          });
          
          channel = pusher.subscribe(data.pusher_channel);
          channel.bind(data.pusher_event, loadVenueEvent);         

      }    

      function createExitButton () {
        let mesh;
        mesh = new PANOLENS.Infospot( MENU_ICON_SIZE, 'assets/exit.png', true);
        mesh.visible = true;
        mesh.name = "Exit";
        mesh.title = 'Exit';
        mesh.position.set( -1000, 0, -1000 );
        mesh.material.opacity = 0;
        mesh.setCursorHoverStyle( 'default' );
        //mesh.addHoverText( 'Exit');
        //mesh.addHoverElement(document.getElementById('menu_exit'), 150);


        //mesh.addEventListener( 'hoverenter', function () {
          //speak("Enter");
        //} );
        
        //mesh.addEventListener( 'hoverleave', function () {
            //speak("Leave");
        //} );
        
        mesh.addEventListener( 'click', function () {
          PlaySound( "assets/see_you_later.mp3");
          window.history.go(-1);
        } );

        panorama.add(mesh);

        return mesh;
      }
      function createQuestionsButton () {
        let mesh;
        mesh = new PANOLENS.Infospot( MENU_ICON_SIZE, 'assets/ask_me.png', true);
        mesh.visible = true;
        mesh.name = "Questions";
        mesh.title = 'Questions';
        mesh.position.set( -1000, -200, -1000 );
        mesh.material.opacity = 0;
        mesh.setCursorHoverStyle( 'default' );
        //mesh.addHoverText( 'Questions');
        //mesh.addHoverElement(document.getElementById('menu_questions'), 150);

        //mesh.addEventListener( 'hoverenter', function () {
          //speak("Enter");
        //} );
        
        //mesh.addEventListener( 'hoverleave', function () {
            //speak("Leave");
        //} );
        
        mesh.addEventListener( 'click', function () {
          //PlaySound( "assets/questions_please.mp3");
          //startAskingQuestions(false);
          callForWhisper();
          panorama.add(mesh);
          panorama.add(questionsBtn);
          panorama.add(exitBtn);
          panorama.add(relaxBtn);
        } );

        panorama.add(mesh);

        return mesh;
      }    
      
      function createLevel1Button () {
        let mesh;
        mesh = new PANOLENS.Infospot( MENU_ICON_SIZE, 'assets/tougle.png', true);
        mesh.visible = true;
        mesh.name = "Level 1";
        mesh.title = 'Level 1';
        mesh.position.set( -1000, -400, -1000 );
        mesh.material.opacity = 0;
        mesh.setCursorHoverStyle( 'default' );
        //mesh.addHoverText( 'Level 1');
        //mesh.addHoverElement(document.getElementById('menu_questions'), 150);

        //mesh.addEventListener( 'hoverenter', function () {
          //speak("Enter");
        //} );
        
        //mesh.addEventListener( 'hoverleave', function () {
            //speak("Leave");
        //} );
        
        mesh.addEventListener( 'click', function () {
          tougleLevel();
          panorama.add(mesh);
          panorama.add(questionsBtn);
          panorama.add(exitBtn);
          panorama.add(relaxBtn);
        } );

        panorama.add(mesh);
        return mesh;
      }     

      function createRelaxButton () {
        let mesh;
        mesh = new PANOLENS.Infospot( MENU_ICON_SIZE, 'assets/relax.png', true);
        mesh.visible = true;
        mesh.name = "Relax";
        mesh.title = 'Relax';
        mesh.position.set( -1000, -600, -1000 );
        mesh.material.opacity = 0;
        mesh.setCursorHoverStyle( 'default' );
        //mesh.addHoverText( 'Relax');
                
        mesh.addEventListener( 'click', function () {
          showWhisper();
          PlaySound('assets/im_here.mp3');
          panorama.add(mesh);
          panorama.add(questionsBtn);
          panorama.add(exitBtn);
          panorama.add(relaxBtn);
        } );

        panorama.add(mesh);
        return mesh;
      }  

      function sleep(ms) {
        //return new Promise(resolve => setTimeout(resolve, ms));
          const start = Date.now();
          while (Date.now() - start < ms) {
        // Just loop until the time has passed
          }
      } 
      function askQuestion(imageSettings) {
        if(imageSettings.questionBuffer != "") {
<<<<<<< HEAD
          sleep(2000);
          speak(imageSettings.questionText);
          recognition.stop()
          recognition.start();
=======
          sleep(3000);
          if(imageSettings.questionVoice != ""){
            PlaySound(imageSettings.questionVoice);
          }else{
            speak(imageSettings.questionText);
          }
          //recognition.stop()
          //recognition.start();
>>>>>>> 8e1beec922e8df69679a25c24d4e2844672c0c63
          console.log("The audio has ended");
        }
      }  
      // Function to handle playing sound and then asking a question

      // Function to play the sound
function PlayMySound(filePath) {
    return new Promise((resolve, reject) => {
        const audio = new Audio(filePath);
        audio.onended = resolve; // Resolve the promise when the sound ends
        audio.onerror = reject;  // Reject the promise if there's an error
        audio.play();
    });
}
async function playSoundAndAskQuestion(filePath) {
    try {
        // Wait for the sound to finish playing
        await PlayMySound(filePath);
        hideWhisper();
        // Once the sound is done, ask the question
        askQuestion(imagesSettings[sessionName]);
    } catch (error) {
        console.error("An error occurred while playing the sound:", error);
    }
}

</script>
</body>
</html>
